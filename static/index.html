<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#800080" />
    <link rel="manifest" href="manifest.json" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <link rel="stylesheet" href="css/index.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <script src = "main.js" ></script>
    <script src="https://js.stripe.com/v3/"></script>
  <script>
      if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('sw.js').then(function(registration) {
        // Success in registration
      }, function(err) {
        // Fail in registration
      });
    });
  }

  </script>
    <title>May</title>
</head>
<body>
<div id="elmroot"></div>
  <script>
const params = new URLSearchParams(window.location.search)
if(params.has('code')){
  // We just came back from an authentication, I'll include the code within
  // the model. We store the code within local storage then make the code disappear!
  // It looks ugly in the URL so bye bye!
  
  localStorage.setItem('may-auth-code', params.get('code'));
  window.location.replace("/");
}
else if(params.has("stripe_status")){
  // This is only for the purpose of getting rid of the status. Which we don't actually need
  window.location.replace("/");
}
else {
  var storedData = localStorage.getItem('may-model');
  var storedData = storedData ? JSON.parse(storedData) : {};
  let code = localStorage.getItem('may-auth-code');
  if(code){
    // Hey! We just came back from an authentication request. Let's pass the code
    // along with the model and remove the code from local storage (we don't need it anymore)
    // We are going to exchange this for an actual token later
    storedData.code = code;
    localStorage.removeItem('may-auth-code');
  }
  var app = Elm.TodoList.init({
    node: document.getElementById('elmroot'),
    flags: storedData
  });


  // Listen for commands from the `setLocalStorage` port.
  // Turn the data to a string and put it in localStorage.
  app.ports.setLocalStorage.subscribe(function(state) {
      localStorage.setItem('may-model', JSON.stringify(state));
  });

  app.ports.openStripe.subscribe(function(sessionId) {
    var stripe = Stripe('pk_test_218Wbt0Tcdvhoy44q2rBg3bw');
    stripe.redirectToCheckout({
      // Make the id field from the Checkout Session creation API response
      // available to this file, so you can provide it as argument here
      // instead of the {{CHECKOUT_SESSION_ID}} placeholder.
      sessionId
    }).then(function (result) {
      console.log(result);
      // If `redirectToCheckout` fails due to a browser or network
      // error, display the localized error message to your customer
      // using `result.error.message`.
    });
  });
  app.ports.setFocus.subscribe(function(id) {
    window.requestAnimationFrame(() => {
      let element = document.getElementById(id)
      if(element){
        element.focus();
      }
    });
  });
}
  </script>
</body>
</html>
